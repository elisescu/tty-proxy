# Define a yaml with:
# ---
# your_subdomain: https://whatever.whatever.whatever
# ssl:
#  chain: path_to_your_chain
#  key: path_to_your_key
#
# ---
load_module /usr/lib/nginx/modules/ngx_stream_module.so;

events { }

# You may have to install the stream module separately


stream {
    # https://nginx.org/en/docs/stream/ngx_stream_core_module.html#server
    # the tty-server tcp connection ssl proxy
    server {
        listen 4567 ssl so_keepalive=30m::10;
        proxy_pass tty-proxy:3456;
        ssl_certificate {{ssl.chain}}; 
        ssl_certificate_key {{ssl.key}};
    }
}

http {

  map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
      }

  server {
      listen 80;
      server_name {{your_subdomain}};
      return 301 https://{{your_subdomain}}$request_uri;
           }

   server {
       listen 443 ssl;
       server_name {{your_subdomain}};
       
       ssl_certificate {{ssl.chain}}; 
       ssl_certificate_key {{ssl.key}};
       
       access_log /var/log/nginx/data-access.log combined;
      
       location / {
              proxy_pass http://tty-proxy:8080;
              proxy_set_header X-Real-IP  $remote_addr;
              proxy_set_header X-Forwarded-For $remote_addr;
              proxy_set_header Host $host;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_redirect http://tty-proxy $scheme://$http_host/;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection $connection_upgrade;
              proxy_read_timeout 20d;
              proxy_buffering off;
              }
      }
}
